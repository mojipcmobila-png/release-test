name: ðŸš€ Release (Test Mode)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Setup Node.js
      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      # 3ï¸âƒ£ Install dependencies
      - name: ðŸ“¥ Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Generate Changelog
      - name: ðŸ“ Generate Changelog
        run: npx changelogithub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # # 5ï¸âƒ£ Build project
      # - name: ðŸ—ï¸ Build
      #   run: npm run build

      # 6ï¸âƒ£ Determine npm tag
      - name: ðŸ·ï¸ Determine npm tag
        id: determine_npm_tag
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          if [[ "$TAG" =~ -(next|canary|beta|rc) ]]; then
            NPM_TAG=${BASH_REMATCH[1]}
          else
            git fetch origin main --depth=1
            if git merge-base --is-ancestor origin/main "$GITHUB_SHA"; then
              NPM_TAG="latest"
            else
              echo "::error::Tag must be from main or version branch (vX.Y.x-latest)"
              exit 1
            fi
          fi

          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT
          echo "Using npm tag: $NPM_TAG"
