name: 🚀 Release (Test Mode)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: 🛒 Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: 🧰 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: 📥 Install dependencies
        run: pnpm install

      - name: 📝 Generate Changelog
        run: npx changelogithub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🏗️ Build
        run: pnpm build

      - name: 🏷️ Determine npm tag
        id: determine_npm_tag
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          if [[ "$TAG" =~ -(next|canary|beta|rc) ]]; then
            NPM_TAG=${BASH_REMATCH[1]}
          else
            git fetch origin main --depth=1
            if git merge-base --is-ancestor origin/main "$GITHUB_SHA"; then
              NPM_TAG="latest"
            else
              echo "::error::Tag must be from main or version branch (vX.Y.x-latest)"
              exit 1
            fi
          fi

          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT
          echo "Using npm tag: $NPM_TAG"
